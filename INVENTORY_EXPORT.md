# 库存查询导出功能说明

## 功能概述
在库存查询页面添加了导出Excel功能,支持一键导出全部库存数据为Excel文件,方便用户进行数据分析和备份。

## 功能特点

### 1. 一键导出
- **位置**: 页面右上角,标题旁边
- **按钮**: "导出Excel"按钮,带有下载图标
- **操作**: 点击按钮即可导出全部库存数据

### 2. 导出内容
导出的Excel文件包含以下字段:
- **产品编号**: 产品的唯一编号
- **产品名称**: 产品的名称
- **货架**: 产品所在货架位置
- **样式**: 产品样式(新品/样机/损坏预售等)
- **累计入库**: 该产品的累计入库数量
- **累计出库**: 该产品的累计出库数量
- **当前库存**: 当前实时库存数量

### 3. 文件格式
- **格式**: Excel (.xlsx)
- **工作表名称**: "库存数据"
- **文件命名**: `库存数据_日期_时间戳.xlsx`
  - 示例: `库存数据_2024-1-16_1705392000000.xlsx`

### 4. 数据特性
- **导出范围**: 全部库存数据(不受搜索过滤影响)
- **数据来源**: inventory_view视图
- **实时性**: 导出时的实时数据
- **完整性**: 包含所有产品的完整库存信息

## 技术实现

### 依赖库
- **xlsx**: 用于生成Excel文件
- 版本: 最新稳定版
- 安装命令: `pnpm add xlsx`

### 核心功能
```typescript
const handleExport = () => {
  // 1. 准备导出数据(中文表头)
  const exportData = inventory.map((item) => ({
    '产品编号': item.product_code,
    '产品名称': item.product_name,
    '货架': item.shelf_name,
    '样式': item.style,
    '累计入库': item.total_inbound || 0,
    '累计出库': item.total_outbound || 0,
    '当前库存': item.current_stock || 0,
  }));

  // 2. 创建工作簿
  const worksheet = XLSX.utils.json_to_sheet(exportData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, '库存数据');

  // 3. 设置列宽
  worksheet['!cols'] = [
    { wch: 15 }, // 产品编号
    { wch: 20 }, // 产品名称
    { wch: 15 }, // 货架
    { wch: 12 }, // 样式
    { wch: 12 }, // 累计入库
    { wch: 12 }, // 累计出库
    { wch: 12 }, // 当前库存
  ];

  // 4. 导出文件
  XLSX.writeFile(workbook, fileName);
};
```

### 用户体验优化
1. **按钮状态管理**:
   - 数据加载中: 按钮禁用
   - 导出中: 显示"导出中..."
   - 无数据: 按钮禁用
   - 正常状态: 显示"导出Excel"

2. **反馈提示**:
   - 导出成功: 显示成功提示和导出数量
   - 导出失败: 显示错误信息

3. **列宽优化**:
   - 根据内容自动设置合适的列宽
   - 确保数据完整显示

## 使用场景

### 1. 数据备份
- 定期导出库存数据进行备份
- 保存历史库存快照

### 2. 数据分析
- 导出数据到Excel进行深度分析
- 制作库存报表和图表
- 进行数据对比和趋势分析

### 3. 数据共享
- 导出数据分享给其他部门
- 提供给管理层进行决策
- 与外部系统进行数据交换

### 4. 打印报表
- 导出后打印库存清单
- 制作库存盘点表

## 注意事项

1. **数据量**: 
   - 导出全部数据,数据量大时可能需要等待
   - 建议在数据量较大时提醒用户

2. **浏览器兼容性**:
   - 支持现代浏览器(Chrome、Firefox、Edge、Safari)
   - 需要浏览器支持文件下载

3. **文件保存**:
   - 文件会自动下载到浏览器默认下载目录
   - 用户可以在浏览器设置中修改下载位置

4. **数据安全**:
   - 导出的数据包含敏感库存信息
   - 建议妥善保管导出的文件

## 未来优化方向

1. **导出选项**:
   - 支持导出当前搜索结果
   - 支持选择导出字段
   - 支持导出为CSV格式

2. **高级功能**:
   - 支持导出时添加统计汇总
   - 支持自定义导出模板
   - 支持批量导出多个工作表

3. **性能优化**:
   - 大数据量时使用流式导出
   - 添加导出进度条
   - 支持后台导出

4. **格式优化**:
   - 添加表头样式(背景色、字体加粗)
   - 添加数据验证
   - 添加条件格式(如低库存标红)

## 相关文件

- **页面文件**: `src/pages/InventoryPage.tsx`
- **类型定义**: `src/types/database.ts` (InventoryView接口)
- **API接口**: `src/db/api.ts` (getInventory函数)
- **依赖包**: `package.json` (xlsx)

## 测试建议

1. **基本功能测试**:
   - 点击导出按钮
   - 检查文件是否成功下载
   - 打开Excel文件验证数据完整性

2. **边界情况测试**:
   - 无数据时导出(按钮应禁用)
   - 数据加载中导出(按钮应禁用)
   - 大量数据导出(测试性能)

3. **兼容性测试**:
   - 不同浏览器测试
   - 不同操作系统测试
   - Excel不同版本打开测试

4. **用户体验测试**:
   - 导出按钮位置是否合理
   - 导出提示是否清晰
   - 文件命名是否易于识别
