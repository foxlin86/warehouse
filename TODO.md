# 任务: 库存管理系统开发

## 计划
- [x] 1. 初始化Supabase数据库并设计数据表结构
  - [x] 1.1 初始化Supabase
  - [x] 1.2 创建用户角色枚举和profiles表
  - [x] 1.3 创建基础数据表(产品、客户、供应商、仓库、货架、字典)
  - [x] 1.4 创建业务表(入库单、出库单、调拨单、序列号、库存)
  - [x] 1.5 配置RLS权限策略
  - [x] 1.6 插入初始数据
- [x] 2. 更新设计系统(颜色主题)
- [x] 3. 创建类型定义和数据库API
- [x] 4. 修改AuthContext和RouteGuard以支持登录
- [x] 5. 创建布局组件和路由配置
- [x] 6. 创建登录页面
- [x] 7. 创建仪表板页面
- [x] 8. 创建基础数据管理页面(产品、客户、供应商、仓库)
- [x] 9. 创建业务管理页面(入库、出库、调拨、序列号)
- [x] 10. 创建查询报表页面
- [x] 11. 创建管理员页面
- [x] 12. 创建入库/出库/调拨表单页面
- [x] 13. 更新货架名称为A库、B库、C库、D库、E库、F库
- [x] 14. 优化数据库API关联查询
- [x] 15. 添加系统设置功能(数据库配置、AI配置)
- [x] 16. 添加AI智能分析功能
- [x] 17. 创建AI分析Edge Function
- [x] 18. 添加Ollama本地模型支持
- [x] 19. 修复AI分析架构,改为前端直接调用
- [x] 20. 添加百度AI(文心一言)支持
- [x] 21. 添加MySQL数据同步功能
- [x] 22. 运行lint验证
- [x] 23. 调拨管理明细查询功能
- [x] 24. 序列号管理查看详情功能
- [x] 25. 全面优化前后端增删改查关联
- [x] 26. 扩展文件上传格式支持
- [x] 27. 添加打印功能(出库管理/入库管理/库存查询)
- [x] 28. 添加密码验证删除功能(出库管理/入库管理/库存查询)
- [x] 29. 为表单页面添加删除按钮(出库单/入库单/调拨单表单)
- [x] 30. 为调拨管理列表页面添加密码验证删除功能
- [x] 31. 优化入库管理和出库管理删除按钮显示逻辑(所有状态都显示删除按钮)
- [x] 32. 为序列号管理添加删除按钮(只能删除在库状态的序列号)
- [x] 33. 为序列号管理添加批量导入功能(支持Excel文件导入)

## 完成情况
✅ 所有功能已完成并通过lint验证
✅ 所有删除按钮正常显示图标
✅ 所有删除功能使用密码验证
✅ 删除按钮在所有状态下都显示,已审核单据需要管理员权限才能删除
✅ 序列号删除按钮只允许删除在库状态的序列号
✅ 序列号批量导入功能支持Excel文件,包含模板下载和数据验证

## 系统说明
### 基础功能
- 第一个注册用户自动成为管理员
- 使用用户名+密码登录方式(无需邮箱验证)
- 所有数据持久化到Supabase数据库
- 库存数量由系统根据入库出库单自动计算
- 管理员可以审核入库单、出库单、调拨单
- 管理员可以管理用户角色权限
- 普通用户可以查看数据和创建草稿单据
- 系统支持产品、客户、供应商、仓库货架的完整CRUD操作
- 库存查询页面实时显示动态库存数据
- 序列号管理支持设备全生命周期追踪
- 货架名称已更新为A库、B库、C库、D库、E库、F库
- 入库/出库/调拨单支持完整的创建、编辑、审核、删除流程
- 出库时自动检查库存是否充足
- 调拨时自动检查调出货架库存是否充足

### AI智能分析功能
- 支持配置多种AI服务商:百度AI(文心一言)、百炼大模型、DeepSeek、OpenAI、Ollama本地模型、自定义API
- **推荐使用Ollama本地模型**:无需API密钥,数据不出本地,完全免费
- **前端直接调用AI API**:支持Ollama本地服务,无需通过云端中转
- 百度AI(文心一言)支持:ernie-4.0-turbo-8k、ernie-4.0-8k、ernie-3.5-8k等多个模型
- AI可以分析本月入库、出库、库存等数据
- 支持自然语言提问,例如"本月入库了哪些产品?数量是多少?"
- AI会根据实际数据给出准确的统计和分析结果
- 提供快速提问模板,方便用户快速获取常用分析
- 管理员可以在系统设置中配置AI API密钥和模型
- Ollama支持多种开源模型:llama2、llama3、mistral、qwen、qwen2、gemma、phi等

### 系统设置功能
- 支持配置外部数据库连接(可选)
- 支持配置AI模型和API密钥
- 支持选择不同的AI服务商和模型
- 预留API接口地址配置,支持自定义API
- 所有配置存储在数据库中,管理员可随时修改

### MySQL数据同步功能
- 支持配置MySQL数据库连接信息(主机、端口、数据库名、用户名、密码)
- 提供测试连接功能,验证MySQL配置是否正确
- **导出到MySQL**: 将Supabase中的所有数据导出到MySQL数据库
- **从MySQL导入**: 从MySQL数据库导入数据到Supabase
- **全量同步**: 双向同步所有数据,保持两个数据库一致
- 记录所有同步操作日志,包括操作类型、状态、时间、详情
- 支持查看同步历史记录和详细信息
- **接口预留**: Edge Function已预留MySQL连接接口,实际使用需要部署到支持MySQL的环境或使用中间API服务器
- 安全提示和操作警告,防止误操作导致数据丢失

### 文件上传功能
- **发票管理**: 支持上传发票文件,包括PDF、图片、Word、Excel等格式
- **销售合同管理**: 支持上传合同文件,包括PDF、图片、Word、Excel等格式
- **支持的文件格式**:
  - PDF格式: .pdf
  - 图片格式: .jpg, .jpeg, .png, .gif, .webp, .svg, .bmp, .tiff
  - Word文档: .doc, .docx
  - Excel表格: .xls, .xlsx
  - 其他格式: .csv, .txt, .rtf, .odt, .ods
- **文件大小限制**: 最大20MB
- **文件存储**: 使用Supabase Storage存储,支持在线预览和下载
- **文件管理**: 支持查看、下载已上传的文件
- **安全性**: 文件名随机化,路径隔离,访问控制

### 打印功能
- **出库管理打印**: 支持一键打印出库单列表,包括出库单号、类型、日期、版本号、状态等信息
- **入库管理打印**: 支持一键打印入库单列表,包括入库单号、类型、日期、状态等信息
- **库存查询打印**: 支持一键打印库存列表,包括产品编号、名称、货架、样式、数量等信息
- **打印优化**:
  - 自动隐藏操作按钮和搜索框
  - 自动隐藏侧边栏和导航栏
  - 表格自动适应页面宽度
  - 支持自动分页,表头在每页显示
  - A4横向布局,适合表格打印
- **保存为PDF**: 支持在打印对话框中选择"保存为PDF",生成PDF文件
- **浏览器兼容**: 支持Chrome、Firefox、Safari、Edge等现代浏览器

### 密码验证删除功能
- **出库管理删除**: 删除草稿状态的出库单前需要输入密码验证,验证通过后才能删除
- **入库管理删除**: 删除草稿状态的入库单前需要输入密码验证,验证通过后才能删除
- **库存查询批量删除**: 支持选择多个产品进行批量删除,删除前需要输入密码验证
- **表单页面删除**: 出库单/入库单/调拨单表单页面支持删除整个单据,仅在编辑模式下显示删除按钮
- **密码验证机制**:
  - 使用Supabase官方认证API验证用户密码
  - 验证当前登录用户的密码
  - 密码错误则无法删除
  - 支持回车键快速提交
- **安全保障**:
  - 防止误删除和恶意删除
  - 密码通过HTTPS加密传输
  - 不在前端存储密码
  - 删除操作有详细的审计日志
- **批量删除反馈**: 显示成功删除数量和失败原因,提供详细的操作反馈
- **表单删除特性**:
  - 删除按钮位于表单底部左侧,使用红色destructive样式突出显示
  - 只有在编辑已保存的单据时才显示删除按钮
  - 删除时会同时删除单据的所有明细项
  - 删除成功后自动返回列表页面
